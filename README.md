# Пример crypto API в браузере

## Полезные ссылки
- [Документация по методам в MDN](https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/generateKey)
- [Документация по алгоритмам и вообще спека в W3C](https://www.w3.org/TR/WebCryptoAPI/#rsa-pss)
- [Как работает TLS - просто занятное чтиво о том, как делается защищенный канал](https://tls.dxdt.ru/tls.html)

## Алгоритм работы
### Регистрация
- Клиент генерирует приватный и публичный ECDH ключи
- Клиент генерирует AES ключ из своего пароля
- AES ключом из пароля шифруется приватный ключ, чтобы защитить
- Публичный ключ и зашифрованный приватный отправляются на сервер при регистрации
- Сервер генерирует приватный и публичный ECDH ключи
- Сервер знает публичный ключ клиента - из этого получается согласованный AES ключ
- Сервер генерирует код восстановления, шифрует его согласованным AES ключом
- Сервер шифрует свой приватный ключ AES ключом, полученным из кода восстановления
- Сервер шифрует данные клиента согласованным AES ключом
- Сервер хранит у себя и при логине передает пользователю:
- - публичный ключ клиента
- - приватный ключ клиента, зашифрованный паролем
- - свой публичный ключ
- - свой приватный ключ, зашифрованный кодом восстановления
- - данные клиента, зашифрованные согласованным ключом
- - код восстановоения, зашифрованный согласованным ключом
- Все эти данные безопасны и не представляют ценности, если не знать пароль пользователя или код восстановления

### Логин и работа с паролями
- Клиент посылает серверу свой email
- Сервер отдает все данные, связанные с клиентом(они же зашифрованы, это безопасно)
- Клиент вводит свой пароль, из пароля делается AES ключ, этим ключом расшифровывает свой приватный ECDH ключ
- С помощью своего приватного ECDH и публичного ECDH сервера клиент делает согласованный AES
- Согласованным AES клиент расшифровывает данные - пароли и код восстановления
- Клиент работает с данными, изменяет их
- Клиент шифрует данные согласованным AES ключом и отправляет их обратно на сервер

### Восстановление пароля
- Клиент не помнит свой пароль, но у него есть код восстановления(если нет - всё пропало)
- Клиент придумывает новый пароль
- Клиент генерирует новые приватный и публичный ECDH ключи, приватный шифрует паролем
- Клиент отправляет на сервер новые ключи и код восстановления
- У сервера есть старый публичный ключ клиента
- Сервер кодом восстановления расшифровывает свой приватный ECDH ключ, получает согласованный AES
- Сервер расшифровывает данные клиента и код восстановления
- Сервер генерирует новый согласованный AES ключ с новым публичным ECDH ключом клиента
- Сервер зашифровывает данные и код восстановления, отправляет клиенту
- Теперь клиент может расшифровать эти данные - публичный ключ сервера не менялся, а данные зашифрованы 
  согласованным ключом, приватная часть для которого у клиента есть - это новый ключ под новым паролем
